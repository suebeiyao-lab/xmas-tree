<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xmas Pro | 修复版</title>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@23.1.1/dist/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <style>
        :root { --gold: #d4af37; --bg: #050a05; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: sans-serif; }
        #start-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #start-btn {
            padding: 20px 50px; background: var(--gold); border: none; border-radius: 40px;
            font-size: 1.2rem; font-weight: bold; cursor: pointer; color: #000;
        }
        #debug-log {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 150px;
            background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace;
            font-size: 10px; overflow-y: auto; pointer-events: none; z-index: 10000;
        }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; color: var(--gold); }
        .upload-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            padding: 12px 25px; border: 1px solid var(--gold); border-radius: 25px; pointer-events: auto;
        }
        #video-wrap { position: absolute; bottom: 20px; right: 20px; width: 80px; height: 100px; border: 1px solid var(--gold); border-radius: 8px; overflow: hidden; transform: scaleX(-1); }
        video { width: 100%; height: 100%; object-fit: cover; }
        #cursor { position: absolute; width: 30px; height: 30px; border: 2px solid var(--gold); border-radius: 50%; transform: translate(-50%, -50%); display: none; z-index: 100; }
    </style>
</head>
<body>

<div id="start-screen">
    <div style="color:var(--gold); font-size:1.5rem; margin-bottom:40px;">XMAS IMMERSIVE 2.0</div>
    <button id="start-btn">确认开启 (需摄像头权限)</button>
    <p id="loading-hint" style="color:var(--gold); opacity:0.6; margin-top:15px; font-size:0.8rem;">若点击无效，请稍等资源加载...</p>
</div>

<div id="debug-log"></div>

<div id="ui-layer">
    <div style="text-align:center; padding:20px;">
        <h2 style="margin:0; letter-spacing:3px;">GOLDEN NIGHT</h2>
        <div id="status" style="font-size:0.7rem; opacity:0.7;">传感器待命</div>
    </div>
    <div class="upload-btn">
        <input type="file" id="photo-input" accept="image/*" multiple style="display:none">
        <label for="photo-input">添加回忆照片</label>
    </div>
</div>

<div id="cursor"></div>
<div id="video-wrap"><video id="webcam" playsinline muted></video></div>

<script>
    // --- 简易调试器 ---
    const logEl = document.getElementById('debug-log');
    function log(msg) {
        const div = document.createElement('div');
        div.innerText = `> ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    // --- 全局变量 ---
    let scene, camera, renderer, composer, treeGroup, treeParticles;
    let photoMeshes = [];
    let targetRotation = { x: 0, y: 0 };
    const raycaster = new THREE.Raycaster();

    // --- 核心初始化 ---
    function initScene() {
        try {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 22);

            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            const renderPass = new THREE.RenderPass(scene, camera);
            const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.1);
            composer = new THREE.EffectComposer(renderer);
            composer.addPass(renderPass);
            composer.addPass(bloomPass);

            treeGroup = new THREE.Group();
            scene.add(treeGroup);

            // 粒子创建
            const count = 1200;
            const geom = new THREE.IcosahedronGeometry(0.12, 0);
            const mat = new THREE.MeshStandardMaterial({ vertexColors: true, emissive: 0xffffff, emissiveIntensity: 1.2 });
            treeParticles = new THREE.InstancedMesh(geom, mat, count);
            const treePos = [], scatterPos = [], currentPos = [];
            for(let i=0; i<count; i++) {
                const r = i/count;
                const p = new THREE.Vector3(Math.cos(r*110)*(1-r)*7, r*16-7, Math.sin(r*110)*(1-r)*7);
                treePos.push(p);
                currentPos.push(p.clone());
                scatterPos.push(new THREE.Vector3((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*30));
                const c = new THREE.Color();
                c.setHSL(Math.random()>0.8?0.1:0.35, 0.8, 0.5);
                treeParticles.setColorAt(i, c);
            }
            treeParticles.userData = { treePos, scatterPos, currentPos };
            treeGroup.add(treeParticles);

            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            log("3D 场景初始化成功");
        } catch(e) { log("3D 错误: " + e.message); }
    }

    // --- AI 启动逻辑 ---
    async function startExperience() {
        log("尝试启动摄像头...");
        const video = document.getElementById('webcam');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            await video.play();
            log("摄像头已连接");

            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6 });
            
            hands.onResults(res => {
                if (!res.multiHandLandmarks || res.multiHandLandmarks.length === 0) {
                    document.getElementById('cursor').style.display = 'none';
                    return;
                }
                const lm = res.multiHandLandmarks[0];
                const x = lm[9].x, y = lm[9].y;
                targetRotation.y = (x - 0.5) * 2;
                targetRotation.x = (y - 0.5) * 1;
                
                const cursor = document.getElementById('cursor');
                cursor.style.display = 'block';
                cursor.style.left = (x * 100) + '%';
                cursor.style.top = (y * 100) + '%';
            });

            const cam = new Camera(video, {
                onFrame: async () => { await hands.send({ image: video }); },
                width: 480, height: 640
            });
            cam.start();
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('status').innerText = "AI 已就绪";
            log("全系统运行中");
        } catch (err) {
            log("启动失败: " + err.name + " - " + err.message);
            if(err.name === 'NotAllowedError') alert("请在浏览器设置中允许摄像头访问！");
        }
    }

    // --- 动画循环 ---
    function animate() {
        requestAnimationFrame(animate);
        if(TWEEN) TWEEN.update();
        if(treeGroup) {
            treeGroup.rotation.y += (targetRotation.y - treeGroup.rotation.y) * 0.1;
            treeGroup.rotation.x += (targetRotation.x - treeGroup.rotation.x) * 0.1;
        }
        if(treeParticles) {
            const dummy = new THREE.Object3D();
            treeParticles.userData.currentPos.forEach((p, i) => {
                dummy.position.copy(p);
                dummy.updateMatrix();
                treeParticles.setMatrixAt(i, dummy.matrix);
            });
            treeParticles.instanceMatrix.needsUpdate = true;
        }
        if(composer) composer.render();
    }

    // --- 启动触发 ---
    window.onload = () => {
        initScene();
        animate();
        document.getElementById('start-btn').onclick = startExperience;
    };
</script>
</body>
</html>